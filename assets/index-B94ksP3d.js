import{V as d,s as G,f as st,t as H,u as O,v as ht,w as mt,L as ot,x as at,A as Ht,y as Ot,z as It,l as ut,Q as At,c as zt,a as Ft,d as Vt,n as Gt,W as _t,G as Wt,H as Nt,J as Ut,K as Xt,M as dt,B as jt,k as Yt,N as qt,j as Kt,O as I,o as pt,D as ft,g as it,U as nt,m as gt,X as Qt,Y as $t,Z as Zt}from"./three-core-qRc6AwJP.js";import{O as Jt,R as te,T as ee}from"./three-extras-H9MAW5Bt.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();const ct=2,lt=1.2,se=new d(0,0,1);function et(m,t=1,e=70){const s=Math.round(m);return Math.max(t,Math.min(e,s))}function yt(m,t,e=ct,s=lt){const i=et(m),n=et(t),r=(i+1)*(n+1),o=new Float32Array(r*3);let c=0;for(let a=0;a<=n;a+=1){const l=(a/n-.5)*s;for(let u=0;u<=i;u+=1){const y=(u/i-.5)*e;o[c]=y,o[c+1]=l,o[c+2]=0,c+=3}}return o}function ie(m,t=new d){return t.copy(se).applyQuaternion(m).normalize()}const L=.05,vt=new d(12.9898,78.233,37.719),Bt=new d(39.3468,11.135,83.155),Rt=new d(73.156,52.235,9.151);function _(m,t,e,s,i){const n=m*s.x+t*s.y+e*s.z+i*.65;return Math.sin(n)*Math.cos(n*1.37+3.1)}function Y(m,t,e,s){return _(m,t,e,vt,s)+_(m,t,e,Bt,s*.65)}function q(m,t,e,s){return _(m,t,e,Bt,s)+_(m,t,e,Rt,s*.72)}function K(m,t,e,s){return _(m,t,e,Rt,s)+_(m,t,e,vt,s*.59)}function Dt(m,t,e,s=new d){const i=Math.max(1e-4,e),n=m.x*i,r=m.y*i,o=m.z*i,c=Y(n,r+L,o,t),a=Y(n,r-L,o,t),h=Y(n,r,o+L,t),l=Y(n,r,o-L,t),u=q(n+L,r,o,t),p=q(n-L,r,o,t),y=q(n,r,o+L,t),g=q(n,r,o-L,t),E=K(n+L,r,o,t),f=K(n-L,r,o,t),S=K(n,r+L,o,t),w=K(n,r-L,o,t),b=(c-a)/(2*L),C=(h-l)/(2*L),M=(u-p)/(2*L),T=(y-g)/(2*L),P=(E-f)/(2*L),B=(S-w)/(2*L);s.set(B-T,C-P,M-b);const R=s.length();return R>1e-5&&s.multiplyScalar(1/R),s}function ne(m,t,e){if(m<=0)return 0;const s=Math.max(1e-4,e),i=Math.exp(-(t*t)/(s*s)),n=Math.exp(-m/(s*5.5));return i*n}class re{maxParticles;trailLength;positions;velocities;ages;lifetimes;trails;pointColors;trailColorHistory;pointsGeometry;pointsMaterial;points;trailGeometry;trailMaterial;trailsMesh;smokeGeometry;smokeMaterial;smokePoints;trailSegments;trailSegmentColors;smokePositions;smokeColors;positionAttribute;pointColorAttribute;trailAttribute;trailColorAttribute;smokePositionAttribute;smokeColorAttribute;smokeSpriteTexture;smokeDisplayEnabled=!1;constructor(t){this.maxParticles=Math.max(1,Math.round(t.maxParticles)),this.trailLength=Math.max(2,Math.round(t.trailLength)),this.positions=new Float32Array(this.maxParticles*3),this.velocities=new Float32Array(this.maxParticles*3),this.ages=new Float32Array(this.maxParticles),this.lifetimes=new Float32Array(this.maxParticles),this.trails=new Float32Array(this.maxParticles*this.trailLength*3),this.pointColors=new Float32Array(this.maxParticles*3),this.trailColorHistory=new Float32Array(this.maxParticles*this.trailLength*3),this.trailSegments=new Float32Array(this.maxParticles*(this.trailLength-1)*2*3),this.trailSegmentColors=new Float32Array(this.maxParticles*(this.trailLength-1)*2*3),this.smokePositions=new Float32Array(this.maxParticles*this.trailLength*3),this.smokeColors=new Float32Array(this.maxParticles*this.trailLength*3);const e=new G(t.particleColor??15070975),s=new G(t.trailColor??t.particleColor??6542079);for(let n=0;n<this.maxParticles;n+=1){const r=n*3;this.pointColors[r]=e.r,this.pointColors[r+1]=e.g,this.pointColors[r+2]=e.b;const o=n*this.trailLength*3;for(let c=0;c<this.trailLength;c+=1){const a=o+c*3;this.trailColorHistory[a]=s.r,this.trailColorHistory[a+1]=s.g,this.trailColorHistory[a+2]=s.b}}this.smokeColors.set(this.trailColorHistory),this.pointsGeometry=new st,this.positionAttribute=new H(this.positions,3),this.positionAttribute.setUsage(O),this.pointsGeometry.setAttribute("position",this.positionAttribute),this.pointColorAttribute=new H(this.pointColors,3),this.pointColorAttribute.setUsage(O),this.pointsGeometry.setAttribute("color",this.pointColorAttribute),this.pointsMaterial=new ht({color:16777215,size:t.particleSize??.03,sizeAttenuation:!0,transparent:!0,opacity:.95,depthWrite:!1,vertexColors:!0}),this.points=new mt(this.pointsGeometry,this.pointsMaterial),this.points.renderOrder=4,this.trailGeometry=new st,this.trailAttribute=new H(this.trailSegments,3),this.trailAttribute.setUsage(O),this.trailGeometry.setAttribute("position",this.trailAttribute),this.trailColorAttribute=new H(this.trailSegmentColors,3),this.trailColorAttribute.setUsage(O),this.trailGeometry.setAttribute("color",this.trailColorAttribute),this.trailMaterial=new ot({color:16777215,transparent:!0,opacity:.5,depthWrite:!1,vertexColors:!0}),this.trailsMesh=new at(this.trailGeometry,this.trailMaterial),this.trailsMesh.renderOrder=3,this.smokeGeometry=new st,this.smokePositionAttribute=new H(this.smokePositions,3),this.smokePositionAttribute.setUsage(O),this.smokeGeometry.setAttribute("position",this.smokePositionAttribute),this.smokeColorAttribute=new H(this.smokeColors,3),this.smokeColorAttribute.setUsage(O),this.smokeGeometry.setAttribute("color",this.smokeColorAttribute),this.smokeSpriteTexture=oe();const i={color:16777215,size:(t.particleSize??.03)*7,sizeAttenuation:!0,transparent:!0,opacity:.12,depthWrite:!1,vertexColors:!0,blending:Ht};this.smokeSpriteTexture&&(i.map=this.smokeSpriteTexture,i.alphaMap=this.smokeSpriteTexture,i.alphaTest=.02),this.smokeMaterial=new ht(i),this.smokePoints=new mt(this.smokeGeometry,this.smokeMaterial),this.smokePoints.renderOrder=2,this.smokePoints.visible=!1}attach(t){t.add(this.trailsMesh),t.add(this.points),t.add(this.smokePoints)}detach(t){t.remove(this.trailsMesh),t.remove(this.points),t.remove(this.smokePoints)}dispose(){this.pointsGeometry.dispose(),this.pointsMaterial.dispose(),this.trailGeometry.dispose(),this.trailMaterial.dispose(),this.smokeGeometry.dispose(),this.smokeMaterial.dispose(),this.smokeSpriteTexture?.dispose()}setSmokeDisplay(t){this.smokeDisplayEnabled=t,this.points.visible=!t,this.trailsMesh.visible=!t,this.smokePoints.visible=t}setParticleColor(t,e,s,i){const n=t*3;this.pointColors[n]=e,this.pointColors[n+1]=s,this.pointColors[n+2]=i}respawnParticle(t,e,s,i){const n=t*3;this.positions[n]=e.x,this.positions[n+1]=e.y,this.positions[n+2]=e.z,this.velocities[n]=s.x,this.velocities[n+1]=s.y,this.velocities[n+2]=s.z,this.ages[t]=0,this.lifetimes[t]=Math.max(.05,i);const r=t*this.trailLength*3;for(let o=0;o<this.trailLength;o+=1){const c=r+o*3;this.trails[c]=e.x,this.trails[c+1]=e.y,this.trails[c+2]=e.z,this.trailColorHistory[c]=this.pointColors[n],this.trailColorHistory[c+1]=this.pointColors[n+1],this.trailColorHistory[c+2]=this.pointColors[n+2]}}pushTrailSample(t){const e=t*3,s=this.positions[e],i=this.positions[e+1],n=this.positions[e+2],r=t*this.trailLength*3;for(let o=this.trailLength-1;o>0;o-=1){const c=r+o*3,a=c-3;this.trails[c]=this.trails[a],this.trails[c+1]=this.trails[a+1],this.trails[c+2]=this.trails[a+2],this.trailColorHistory[c]=this.trailColorHistory[a],this.trailColorHistory[c+1]=this.trailColorHistory[a+1],this.trailColorHistory[c+2]=this.trailColorHistory[a+2]}this.trails[r]=s,this.trails[r+1]=i,this.trails[r+2]=n,this.trailColorHistory[r]=this.pointColors[e],this.trailColorHistory[r+1]=this.pointColors[e+1],this.trailColorHistory[r+2]=this.pointColors[e+2]}clearTrailsToCurrentPositions(){for(let t=0;t<this.maxParticles;t+=1){const e=t*3,s=this.positions[e],i=this.positions[e+1],n=this.positions[e+2],r=t*this.trailLength*3;for(let o=0;o<this.trailLength;o+=1){const c=r+o*3;this.trails[c]=s,this.trails[c+1]=i,this.trails[c+2]=n,this.trailColorHistory[c]=this.pointColors[e],this.trailColorHistory[c+1]=this.pointColors[e+1],this.trailColorHistory[c+2]=this.pointColors[e+2]}}}syncTrailColorHistoryToParticleColors(){for(let t=0;t<this.maxParticles;t+=1){const e=t*3,s=t*this.trailLength*3;for(let i=0;i<this.trailLength;i+=1){const n=s+i*3;this.trailColorHistory[n]=this.pointColors[e],this.trailColorHistory[n+1]=this.pointColors[e+1],this.trailColorHistory[n+2]=this.pointColors[e+2]}}}refreshGpuBuffers(){this.positionAttribute.needsUpdate=!0,this.pointColorAttribute.needsUpdate=!0,this.refreshTrailSegmentsFromHistory(),this.trailAttribute.needsUpdate=!0,this.trailColorAttribute.needsUpdate=!0,this.smokeDisplayEnabled&&(this.refreshSmokePointsFromHistory(),this.smokePositionAttribute.needsUpdate=!0,this.smokeColorAttribute.needsUpdate=!0,this.smokeGeometry.computeBoundingSphere()),this.pointsGeometry.computeBoundingSphere(),this.trailGeometry.computeBoundingSphere()}refreshTrailSegmentsFromHistory(){let t=0;for(let e=0;e<this.maxParticles;e+=1){const s=e*this.trailLength*3;for(let i=0;i<this.trailLength-1;i+=1){const n=s+i*3,r=n+3;this.trailSegments[t]=this.trails[n],this.trailSegments[t+1]=this.trails[n+1],this.trailSegments[t+2]=this.trails[n+2],this.trailSegments[t+3]=this.trails[r],this.trailSegments[t+4]=this.trails[r+1],this.trailSegments[t+5]=this.trails[r+2],this.trailSegmentColors[t]=this.trailColorHistory[n],this.trailSegmentColors[t+1]=this.trailColorHistory[n+1],this.trailSegmentColors[t+2]=this.trailColorHistory[n+2],this.trailSegmentColors[t+3]=this.trailColorHistory[r],this.trailSegmentColors[t+4]=this.trailColorHistory[r+1],this.trailSegmentColors[t+5]=this.trailColorHistory[r+2],t+=6}}}refreshSmokePointsFromHistory(){this.smokePositions.set(this.trails),this.smokeColors.set(this.trailColorHistory)}}function oe(){if(typeof document>"u")return null;const m=64,t=document.createElement("canvas");t.width=m,t.height=m;const e=t.getContext("2d");if(!e)return null;const s=m*.5,i=e.createRadialGradient(s,s,0,s,s,s);i.addColorStop(0,"rgba(255, 255, 255, 0.85)"),i.addColorStop(.45,"rgba(255, 255, 255, 0.35)"),i.addColorStop(1,"rgba(255, 255, 255, 0)"),e.fillStyle=i,e.fillRect(0,0,m,m);const n=new Ot(t);return n.needsUpdate=!0,n}function ae(m=1){return{isPlaying:!0,speed:m}}function ce(m){m.isPlaying=!0}function le(m){m.isPlaying=!1}function he(m){m.isPlaying=!0}function St(){return{shapeKind:"plane",center:new d,normal:new d(0,0,1),xAxis:new d(1,0,0),yAxis:new d(0,1,0),worldMatrix:new ut,inverseWorldMatrix:new ut,worldNormalMatrix:new It,scaleX:1,scaleY:1,scaleZ:1,halfWidth:.5,halfHeight:.5,halfDepth:.01,boundingRadius:Math.sqrt(.5*.5+.5*.5+.01*.01),sphereRadius:.5,torusMajorRadius:.34,torusMinorRadius:.16,influenceRadius:.45,wakeStrength:.8}}const Q=new d,$=new At,wt=new d,D=new d,x=new d,v=new d,V=new d,Ct=new d,Z=new d;function me(m,t,e,s){m.updateMatrixWorld(!0),m.getWorldPosition(s.center),m.getWorldScale(Q),m.getWorldQuaternion($),s.worldMatrix.copy(m.matrixWorld),s.inverseWorldMatrix.copy(m.matrixWorld).invert(),s.worldNormalMatrix.getNormalMatrix(m.matrixWorld);const i=m.userData?.obstacleShape;s.shapeKind=i==="box"||i==="sphere"||i==="pyramid"||i==="torus"?i:"plane",s.normal.set(0,0,1).applyQuaternion($).normalize(),s.xAxis.set(1,0,0).applyQuaternion($).normalize(),s.yAxis.set(0,1,0).applyQuaternion($).normalize();const n=m.geometry;n&&n.computeBoundingBox();const r=n?.boundingBox?n.boundingBox.getSize(wt):wt.set(1,1,1),o=Math.max(1e-4,Math.abs(Q.x)),c=Math.max(1e-4,Math.abs(Q.y)),a=Math.max(1e-4,Math.abs(Q.z));s.scaleX=o,s.scaleY=c,s.scaleZ=a,s.halfWidth=Math.max(1e-4,r.x*.5),s.halfHeight=Math.max(1e-4,r.y*.5),s.halfDepth=Math.max(1e-4,r.z*.5);const h=s.halfWidth*o,l=s.halfHeight*c,u=s.halfDepth*a;s.boundingRadius=Math.sqrt(h*h+l*l+u*u);const p=m.userData?.obstacleParams;return s.sphereRadius=Math.max(1e-4,p?.radius??Math.max(r.x,r.y,r.z)*.5),s.torusMajorRadius=Math.max(1e-4,p?.majorRadius??.34),s.torusMinorRadius=Math.max(1e-4,p?.minorRadius??.16),s.influenceRadius=t,s.wakeStrength=e,s}const z=new d,J=new d,xt=new d,tt=new d,bt=new d,F=new d,Et=new d;function A(m,t,e){return Math.max(t,Math.min(e,m))}function ue(m,t,e,s,i){if(m==="sphere"){const g=Math.max(1e-4,i.sphereRadius),E=1/(g*g),f=(t*t+e*e+s*s)*E-1,S=2*t*E,w=2*e*E,b=2*s*E,C=Math.sqrt(S*S+w*w+b*b);C>1e-6?x.set(S/C,w/C,b/C):x.set(0,0,1);const M=C>1e-6?f/C:g;return V.set(t-x.x*M,e-x.y*M,s-x.z*M),M}if(m==="torus"){const g=Math.max(1e-4,i.torusMajorRadius),E=Math.max(1e-4,i.torusMinorRadius),f=Math.sqrt(t*t+e*e),S=f-g,w=s,b=Math.sqrt(S*S+w*w),C=b-E;if(f>1e-6&&b>1e-6){const M=t/f,T=e/f,P=S/b;x.set(M*P,T*P,w/b).normalize()}else x.set(0,0,1);return V.set(t-x.x*C,e-x.y*C,s-x.z*C),C}if(m==="pyramid"){const g=Math.max(1e-4,i.halfWidth),E=Math.max(1e-4,i.halfHeight),f=Math.max(1e-4,i.halfDepth),S=A(s,-f,f),w=A((f-S)/(2*f),0,1),b=Math.max(1e-5,g*w),C=Math.max(1e-5,E*w),M=A(t,-b,b),T=A(e,-C,C);V.set(M,T,S),D.set(t-M,e-T,s-S);const P=D.length();if(!(s>=-f&&s<=f&&Math.abs(t)<=b&&Math.abs(e)<=C))return P>1e-6?x.copy(D).normalize():x.set(0,0,1),P;const R=b-Math.abs(t),j=C-Math.abs(e),W=f-s,N=s+f,k=Math.min(R,j,W,N);return k===W?x.set(0,0,1):k===N?x.set(0,0,-1):k===R?x.set(Math.sign(t)||1,0,g/(2*f)).normalize():x.set(0,Math.sign(e)||1,E/(2*f)).normalize(),V.set(t-x.x*k,e-x.y*k,s-x.z*k),-k}const n=Math.max(1e-4,i.halfWidth),r=Math.max(1e-4,i.halfHeight),o=m==="plane"?Math.max(1e-4,i.influenceRadius*.25):Math.max(1e-4,i.halfDepth),c=A(t,-n,n),a=A(e,-r,r),h=A(s,-o,o);V.set(c,a,h),D.set(t-c,e-a,s-h);const l=D.length();if(l>1e-6)return x.copy(D).normalize(),l;const u=n-Math.abs(t),p=r-Math.abs(e),y=o-Math.abs(s);return u<=p&&u<=y?(x.set(Math.sign(t)||1,0,0),-u):p<=u&&p<=y?(x.set(0,Math.sign(e)||1,0),-p):(x.set(0,0,Math.sign(s)||1),-y)}function de(m,t,e,s,i,n,r){z.copy(m).sub(e.center),Z.copy(m).applyMatrix4(e.inverseWorldMatrix);const o=Z.x,c=Z.y,a=Z.z,h=Math.max(.01,e.influenceRadius);ue(e.shapeKind,o,c,a,e),v.copy(x).applyMatrix3(e.worldNormalMatrix).normalize(),Ct.copy(V).applyMatrix4(e.worldMatrix),D.copy(m).sub(Ct);const l=D.dot(v),u=l<=h;if(u){const w=Math.min(.05,h*.35);if(l<w){const M=w-l+1e-4;m.addScaledVector(v,M)}const b=t.dot(v);if(b<0&&t.addScaledVector(v,-b),J.copy(z).addScaledVector(v,-z.dot(v)),J.lengthSq()>1e-6){J.normalize();const M=1-A(l/h,0,1);t.addScaledVector(J,.65*M)}const C=A(l/h,0,1);if(tt.copy(s).addScaledVector(v,-s.dot(v)),tt.lengthSq()>1e-6&&(tt.normalize(),t.addScaledVector(tt,.35*(1-C))),e.shapeKind!=="plane"){const M=A(v.dot(s),0,1),T=(1-C)*M;if(T>1e-4){const P=.75*T,B=t.dot(s);B<P&&t.addScaledVector(s,P-B)}}}const p=z.dot(s)-e.boundingRadius;if(p<=0)return u;const y=z.dot(s);xt.copy(s).multiplyScalar(y),bt.copy(z).sub(xt);const g=bt.length(),E=e.shapeKind==="torus"?Math.max((e.torusMajorRadius+e.torusMinorRadius)*e.scaleX,(e.torusMajorRadius+e.torusMinorRadius)*e.scaleY,e.torusMinorRadius*e.scaleZ)+h:e.shapeKind==="sphere"?Math.max(e.sphereRadius*e.scaleX,e.sphereRadius*e.scaleY,e.sphereRadius*e.scaleZ)+h:Math.max(e.halfWidth*e.scaleX,e.halfHeight*e.scaleY,e.halfDepth*e.scaleZ)+h,f=ne(p,g,E);if(f<=1e-5)return u;if(!u&&p>h*.35){const w=t.length();if(w>1e-5){const b=A(f*.22,0,.2);Et.copy(s).multiplyScalar(w),t.lerp(Et,b)}}const S=Math.max(0,r);if(S>1e-5){Dt(m,i,n,F),F.addScaledVector(s,-F.dot(s));const w=F.lengthSq();w>1e-6&&(F.multiplyScalar(1/Math.sqrt(w)),t.addScaledVector(F,f*e.wakeStrength*S))}return u}const U=4200,pe=22,X=1e-4,fe=1.25,ge=.4,ye=2/3,Se=1.12,we=.95,Ce=1.15,xe=1.75,rt="#1100ff",Mt="#ff8552",be=.9,Lt=.1,Ee=.5,Me=.65,Pt=1801893,Le=5696767,Tt=6255498,Pe=16764794;class Te{canvas;renderer;scene;camera;orbitControls;transformControls;transformHelpers;uiElements;uiCleanupCallbacks=[];uiRangeBindings=[];raycaster=new zt;pointer=new Ft;emitterConfig={densityX:20,densityY:12,spawnRate:1,initialSpeed:2.7,particleLifetime:7.2,trailLength:pe};flowConfig={timeScale:1,drag:.8,turbulenceStrength:0,turbulenceScale:.35,recoveryLength:1,obstacleInfluenceRadius:.1,wakeStrength:1.05};playbackState=ae(5);uiState={densityX:20,densityY:12,flowSpeed:5,flowLength:6,pathColor:rt,obstructedColor:Mt,turbulence:0,recoveryLength:1,impactBuffer:.1,smokeDisplay:!1};particleSystem;planeEntities=new Map;selectable=new Set;obstacleRuntimes=[];emitterId="emitter-1";obstacleCounter=0;selectedPlaneId=null;emitterLocalVertices=yt(this.emitterConfig.densityX,this.emitterConfig.densityY);emitterWorldVertices=new Float32Array(this.emitterLocalVertices.length);emitterNormal=new d(0,0,1);emitterRight=new d(1,0,0);emitterUp=new d(0,1,0);particleLaneOrigins=new Float32Array(U*3);particleLaneDirections=new Float32Array(U*3);particleOffPathAmounts=new Float32Array(U);particleImpactTurbulence=new Float32Array(U);quaternionScratch=new At;positionScratch=new d;velocityScratch=new d;baseFlowScratch=new d;steeringScratch=new d;turbulenceScratch=new d;laneOriginScratch=new d;laneDirectionScratch=new d;laneTargetScratch=new d;pathColorScratch=new G(rt);obstructedColorScratch=new G(Mt);blendedColorScratch=new G(rt);scalePickerMaterial=new Vt({transparent:!0,opacity:0,depthTest:!1,depthWrite:!1,toneMapped:!1});environmentRenderTarget=null;isTransformDragging=!1;isUsingTransformControls=!1;pendingTrailGradientRecolor=!1;spawnAccumulator=0;spawnParticleCursor=0;spawnVertexCursor=0;simTime=0;animationFrameHandle=0;lastAnimationTimeSeconds=performance.now()*.001;onResizeBound;onPointerDownBound;onKeyDownBound;constructor(t){this.canvas=t,this.scene=new Gt,this.scene.background=new G(0),this.renderer=new _t({canvas:this.canvas,antialias:!0}),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.outputColorSpace=Wt,this.renderer.toneMapping=Nt,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=Ut,this.camera=new Xt(55,window.innerWidth/window.innerHeight,.1,300),this.camera.position.set(8,5.5,8),this.orbitControls=new Jt(this.camera,this.renderer.domElement),this.orbitControls.enableDamping=!0,this.orbitControls.dampingFactor=.08,this.orbitControls.mouseButtons.LEFT=void 0,this.orbitControls.mouseButtons.MIDDLE=dt.PAN,this.orbitControls.mouseButtons.RIGHT=dt.ROTATE;const e=this.createTransformControl("translate",1),s=this.createTransformControl("rotate",.5),i=this.createTransformControl("scale",.42);this.transformControls=[e.control,s.control,i.control],this.transformHelpers=[e.helper,s.helper,i.helper],this.setupSceneHelpers(),this.setupEnvironment(),this.uiElements=this.resolveUiElements(),this.createEmitterEntity(),this.particleSystem=new re({maxParticles:U,trailLength:this.emitterConfig.trailLength,particleColor:15070975,trailColor:6542079,particleSize:.03}),this.particleSystem.attach(this.scene),this.setupUi(),this.selectPlane(this.emitterId),this.updateSpawnRateFromDensity(),this.restart(),this.onResizeBound=()=>this.handleResize(),this.onPointerDownBound=n=>this.handlePointerDown(n),this.onKeyDownBound=n=>this.handleKeyDown(n),window.addEventListener("resize",this.onResizeBound),this.canvas.addEventListener("pointerdown",this.onPointerDownBound),window.addEventListener("keydown",this.onKeyDownBound),this.animationLoop()}addObstaclePlane(){const t=`obstacle-${++this.obstacleCounter}`,e=this.createPlaneEntity(t,"obstacle",6255498,1,1,1,1);return e.scaleProxy.scale.set(1.8,.95,1),this.registerObstacleEntity(t,e),t}addObstacleBox(){const t=`obstacle-${++this.obstacleCounter}`,e=1,s=.62,i=.62,n=new jt(e,s,i,1,1,1),r=this.createObstacleEntity(t,"box",n,{width:e,height:s,depth:i});return r.scaleProxy.scale.set(1.2,1,1),this.registerObstacleEntity(t,r),t}addObstacleSphere(){const t=`obstacle-${++this.obstacleCounter}`,e=.5,s=new Yt(e,20,14),i=this.createObstacleEntity(t,"sphere",s,{radius:e});return i.scaleProxy.scale.set(1.05,1.05,1),this.registerObstacleEntity(t,i),t}addObstaclePyramid(){const t=`obstacle-${++this.obstacleCounter}`,e=.5,s=1,i=new qt(e,s,4,1);i.rotateX(Math.PI*.5);const n=this.createObstacleEntity(t,"pyramid",i,{radius:e,height:s});return n.scaleProxy.scale.set(1.05,1.05,1),this.registerObstacleEntity(t,n),t}addObstacleTorus(){const t=`obstacle-${++this.obstacleCounter}`,e=.34,s=.16,i=new Kt(e,s,14,28),n=this.createObstacleEntity(t,"torus",i,{majorRadius:e,minorRadius:s});return n.scaleProxy.scale.set(1.15,1.15,1),this.registerObstacleEntity(t,n),t}play(){ce(this.playbackState)}pause(){le(this.playbackState)}restart(){he(this.playbackState),this.simTime=0,this.pendingTrailGradientRecolor=!1,this.spawnAccumulator=0,this.spawnParticleCursor=0,this.spawnVertexCursor=0,this.updateAllWorldMatrices(),this.refreshEmitterSpawnData(),this.refreshObstacleFieldData(),this.initializeRestartParticleDistribution(),this.particleSystem.clearTrailsToCurrentPositions(),this.particleSystem.refreshGpuBuffers()}setEmitterDensity(t,e){const s=et(t),i=et(e);s===this.emitterConfig.densityX&&i===this.emitterConfig.densityY||(this.emitterConfig.densityX=s,this.emitterConfig.densityY=i,this.uiState.densityX=s,this.uiState.densityY=i,this.rebuildEmitterGeometry(),this.updateSpawnRateFromDensity(),this.restart())}dispose(){cancelAnimationFrame(this.animationFrameHandle),window.removeEventListener("resize",this.onResizeBound),this.canvas.removeEventListener("pointerdown",this.onPointerDownBound),window.removeEventListener("keydown",this.onKeyDownBound);for(const t of this.uiCleanupCallbacks)t();this.uiCleanupCallbacks.length=0;for(const t of this.transformHelpers)this.scene.remove(t);for(const t of this.transformControls){const s=t._gizmo?.picker?.scale;if(s)for(const i of[...s.children]){if(!i.userData?.customScalePicker)continue;i.geometry?.dispose(),s.remove(i)}t.dispose()}this.scalePickerMaterial.dispose(),this.orbitControls.dispose(),this.particleSystem.detach(this.scene),this.particleSystem.dispose();for(const t of this.planeEntities.values())this.disposePlaneEntity(t);this.planeEntities.clear(),this.selectable.clear(),this.obstacleRuntimes.length=0,this.environmentRenderTarget&&(this.environmentRenderTarget.dispose(),this.environmentRenderTarget=null),this.renderer.dispose()}createEmitterEntity(){const t=this.createPlaneEntity(this.emitterId,"emitter",Pt,ct,lt,1,1);t.transformObject.position.set(0,1.4,-2.8),t.transformObject.rotation.set(0,0,0),t.scaleProxy.scale.set(1,1,1),this.scene.add(t.transformObject),this.planeEntities.set(this.emitterId,t),this.selectable.add(t.mesh),this.rebuildEmitterGeometry()}registerObstacleEntity(t,e){e.transformObject.position.set((this.obstacleCounter%5-2)*1.1,1+(this.obstacleCounter%3-1)*.35,-.5+this.obstacleCounter*.5),e.transformObject.rotation.set(0,0,0),this.scene.add(e.transformObject),this.planeEntities.set(t,e),this.selectable.add(e.mesh),this.obstacleRuntimes.push({id:t,data:St()}),this.selectPlane(t)}createObstacleEntity(t,e,s,i){const n=new I,r=new I;r.scale.set(1,1,1);const o=new I,c=new pt({color:Tt,roughness:.55,metalness:.05,transparent:!0,opacity:.38,side:ft}),a=new it(s,c);a.userData.planeId=t,a.userData.obstacleShape=e,a.userData.obstacleParams=i;const h=new ot({color:16777215,transparent:!0,opacity:.45}),l=new at(new nt(s),h);return o.add(a),o.add(l),r.add(o),n.add(r),{id:t,kind:"obstacle",transformObject:n,scaleProxy:r,object:o,mesh:a,outline:l}}createPlaneEntity(t,e,s,i,n,r,o){const c=new I,a=new I;a.scale.set(Math.max(X,i),Math.max(X,n),1);const h=new I,l=new gt(1,1,r,o),u=new pt({color:s,roughness:.55,metalness:.05,transparent:!0,opacity:e==="emitter"?.3:.38,side:ft}),p=new it(l,u);p.userData.planeId=t,e==="obstacle"&&(p.userData.obstacleShape="plane",p.userData.obstacleParams={width:1,height:1,depth:0});const y=new ot({color:16777215,transparent:!0,opacity:.45}),g=new at(new nt(l),y);return h.add(p),h.add(g),a.add(h),c.add(a),{id:t,kind:e,transformObject:c,scaleProxy:a,object:h,mesh:p,outline:g}}disposePlaneEntity(t){const e=t.outline.material;if(Array.isArray(e))for(const s of e)s.dispose();else e.dispose();t.outline.geometry.dispose(),t.mesh.geometry.dispose(),t.mesh.material.dispose(),t.object.remove(t.outline),t.object.remove(t.mesh),t.scaleProxy.remove(t.object),t.transformObject.remove(t.scaleProxy),this.scene.remove(t.transformObject)}rebuildEmitterGeometry(){const t=this.planeEntities.get(this.emitterId);if(!t)return;const e=new gt(ct,lt,this.emitterConfig.densityX,this.emitterConfig.densityY);t.mesh.geometry.dispose(),t.mesh.geometry=e,t.outline.geometry.dispose(),t.outline.geometry=new nt(e),this.emitterLocalVertices=yt(this.emitterConfig.densityX,this.emitterConfig.densityY),this.emitterWorldVertices=new Float32Array(this.emitterLocalVertices.length)}removeObstacle(t){const e=this.planeEntities.get(t);if(!e||e.kind!=="obstacle")return;this.selectable.delete(e.mesh),this.disposePlaneEntity(e),this.planeEntities.delete(t);const s=this.obstacleRuntimes.findIndex(i=>i.id===t);s>=0&&this.obstacleRuntimes.splice(s,1),this.selectedPlaneId===t&&this.selectPlane(null)}selectPlane(t){this.selectedPlaneId=t,this.refreshSelectionVisuals(),this.updateTransformControlAttachments()}refreshSelectionVisuals(){for(const[t,e]of this.planeEntities)e.kind==="emitter"?e.mesh.material.color.setHex(t===this.selectedPlaneId?Le:Pt):e.mesh.material.color.setHex(t===this.selectedPlaneId?Pe:Tt)}updateTransformControlAttachments(){for(const n of this.transformControls)n.detach();if(!this.selectedPlaneId)return;const t=this.planeEntities.get(this.selectedPlaneId);if(!t)return;const[e,s,i]=this.transformControls;e?.attach(t.transformObject),s?.attach(t.transformObject),i?.attach(t.scaleProxy)}handleScaleProxyObjectChange(){if(!this.selectedPlaneId)return;const t=this.planeEntities.get(this.selectedPlaneId);t&&t.scaleProxy.scale.set(Math.max(X,Math.abs(t.scaleProxy.scale.x)),Math.max(X,Math.abs(t.scaleProxy.scale.y)),t.kind==="emitter"?1:Math.max(X,Math.abs(t.scaleProxy.scale.z)))}setupSceneHelpers(){const t=new Qt(16777215,.62);this.scene.add(t);const e=new $t(16777215,1.08);e.position.set(9,10,4),this.scene.add(e)}setupEnvironment(){const t=new Zt(this.renderer),e=new te;this.environmentRenderTarget=t.fromScene(e,fe),this.scene.environment=this.environmentRenderTarget.texture,e.dispose(),t.dispose()}resolveUiElements(){const t=document.getElementById("ui-panel"),e=document.getElementById("ui-handle"),s=document.getElementById("ui-handle-bottom"),i=document.getElementById("collapse-toggle"),n=document.getElementById("play-sim"),r=document.getElementById("pause-sim"),o=document.getElementById("restart-sim"),c=document.getElementById("add-plane"),a=document.getElementById("add-box"),h=document.getElementById("add-sphere"),l=document.getElementById("add-pyramid"),u=document.getElementById("add-torus"),p=document.getElementById("flow-speed"),y=document.getElementById("flow-speed-value"),g=document.getElementById("flow-length"),E=document.getElementById("flow-length-value"),f=document.getElementById("path-color"),S=document.getElementById("obstructed-color"),w=document.getElementById("turbulence-strength"),b=document.getElementById("turbulence-value"),C=document.getElementById("recovery-length"),M=document.getElementById("recovery-length-value"),T=document.getElementById("impact-buffer"),P=document.getElementById("impact-buffer-value"),B=document.getElementById("smoke-display"),R=document.getElementById("density-x"),j=document.getElementById("density-x-value"),W=document.getElementById("density-y"),N=document.getElementById("density-y-value");if(!(t instanceof HTMLDivElement)||!(e instanceof HTMLDivElement)||!(s instanceof HTMLDivElement)||!(i instanceof HTMLButtonElement)||!(n instanceof HTMLButtonElement)||!(r instanceof HTMLButtonElement)||!(o instanceof HTMLButtonElement)||!(c instanceof HTMLButtonElement)||!(a instanceof HTMLButtonElement)||!(h instanceof HTMLButtonElement)||!(l instanceof HTMLButtonElement)||!(u instanceof HTMLButtonElement)||!(p instanceof HTMLInputElement)||!(y instanceof HTMLSpanElement)||!(g instanceof HTMLInputElement)||!(E instanceof HTMLSpanElement)||!(f instanceof HTMLInputElement)||!(S instanceof HTMLInputElement)||!(w instanceof HTMLInputElement)||!(b instanceof HTMLSpanElement)||!(C instanceof HTMLInputElement)||!(M instanceof HTMLSpanElement)||!(T instanceof HTMLInputElement)||!(P instanceof HTMLSpanElement)||!(B instanceof HTMLInputElement)||!(R instanceof HTMLInputElement)||!(j instanceof HTMLSpanElement)||!(W instanceof HTMLInputElement)||!(N instanceof HTMLSpanElement))throw new Error("UI elements for controls panel are missing or invalid.");return{panel:t,handleTop:e,handleBottom:s,collapseToggle:i,playButton:n,pauseButton:r,restartButton:o,addPlaneButton:c,addBoxButton:a,addSphereButton:h,addPyramidButton:l,addTorusButton:u,flowSpeedRange:p,flowSpeedValue:y,flowLengthRange:g,flowLengthValue:E,pathColorInput:f,obstructedColorInput:S,turbulenceRange:w,turbulenceValue:b,recoveryLengthRange:C,recoveryLengthValue:M,impactBufferRange:T,impactBufferValue:P,smokeDisplayToggle:B,densityXRange:R,densityXValue:j,densityYRange:W,densityYValue:N}}setupUi(){this.bindRangeControl({input:this.uiElements.flowSpeedRange,value:this.uiElements.flowSpeedValue,format:t=>t.toFixed(2)},t=>{this.uiState.flowSpeed=t,this.playbackState.speed=t},this.uiState.flowSpeed),this.bindRangeControl({input:this.uiElements.flowLengthRange,value:this.uiElements.flowLengthValue,format:t=>t.toFixed(2)},t=>{this.uiState.flowLength=t},this.uiState.flowLength),this.uiElements.pathColorInput.value=this.uiState.pathColor,this.uiElements.obstructedColorInput.value=this.uiState.obstructedColor,this.uiElements.smokeDisplayToggle.checked=this.uiState.smokeDisplay,this.particleSystem.setSmokeDisplay(this.uiState.smokeDisplay),this.syncParticleGradientEndpoints(),this.addDomListener(this.uiElements.pathColorInput,"input",()=>{this.uiState.pathColor=this.uiElements.pathColorInput.value,this.syncParticleGradientEndpoints(),this.pendingTrailGradientRecolor=!0}),this.addDomListener(this.uiElements.obstructedColorInput,"input",()=>{this.uiState.obstructedColor=this.uiElements.obstructedColorInput.value,this.syncParticleGradientEndpoints(),this.pendingTrailGradientRecolor=!0}),this.addDomListener(this.uiElements.smokeDisplayToggle,"change",()=>{this.uiState.smokeDisplay=this.uiElements.smokeDisplayToggle.checked,this.particleSystem.setSmokeDisplay(this.uiState.smokeDisplay),this.particleSystem.refreshGpuBuffers()}),this.bindRangeControl({input:this.uiElements.turbulenceRange,value:this.uiElements.turbulenceValue,format:t=>t.toFixed(2)},t=>{this.uiState.turbulence=t,this.flowConfig.turbulenceStrength=t},this.uiState.turbulence),this.bindRangeControl({input:this.uiElements.recoveryLengthRange,value:this.uiElements.recoveryLengthValue,format:t=>t.toFixed(2)},t=>{this.uiState.recoveryLength=t,this.flowConfig.recoveryLength=t},this.uiState.recoveryLength),this.bindRangeControl({input:this.uiElements.impactBufferRange,value:this.uiElements.impactBufferValue,format:t=>t.toFixed(2)},t=>{this.uiState.impactBuffer=t,this.flowConfig.obstacleInfluenceRadius=t},this.uiState.impactBuffer),this.bindRangeControl({input:this.uiElements.densityXRange,value:this.uiElements.densityXValue,format:t=>String(Math.round(t))},t=>{this.setEmitterDensity(t,this.uiState.densityY)},this.uiState.densityX),this.bindRangeControl({input:this.uiElements.densityYRange,value:this.uiElements.densityYValue,format:t=>String(Math.round(t))},t=>{this.setEmitterDensity(this.uiState.densityX,t)},this.uiState.densityY),this.addDomListener(this.uiElements.playButton,"click",()=>this.play()),this.addDomListener(this.uiElements.pauseButton,"click",()=>this.pause()),this.addDomListener(this.uiElements.restartButton,"click",()=>this.restart()),this.addDomListener(this.uiElements.addPlaneButton,"click",()=>this.addObstaclePlane()),this.addDomListener(this.uiElements.addBoxButton,"click",()=>this.addObstacleBox()),this.addDomListener(this.uiElements.addSphereButton,"click",()=>this.addObstacleSphere()),this.addDomListener(this.uiElements.addPyramidButton,"click",()=>this.addObstaclePyramid()),this.addDomListener(this.uiElements.addTorusButton,"click",()=>this.addObstacleTorus()),this.setupUiPanelInteractions(),this.refreshAllRangeProgress()}setupUiPanelInteractions(){const{panel:t,handleTop:e,handleBottom:s,collapseToggle:i}=this.uiElements;let n=null;this.addDomListener(i,"pointerdown",l=>{l.stopPropagation()}),this.addDomListener(i,"click",()=>{const l=t.classList.toggle("is-collapsed");i.setAttribute("aria-expanded",l?"false":"true"),this.clampPanelToViewport(),requestAnimationFrame(()=>this.refreshAllRangeProgress())});const r=t.querySelectorAll(".panel-section .panel-heading");for(const l of r)this.addDomListener(l,"click",()=>{const u=l.closest(".panel-section");if(!u)return;const p=u.classList.toggle("is-collapsed");l.setAttribute("aria-expanded",p?"false":"true"),this.clampPanelToViewport(),requestAnimationFrame(()=>this.refreshAllRangeProgress())});const o=l=>{const u=l,p=u.target;if(p instanceof Element&&p.closest(".collapse-button"))return;const y=u.currentTarget;y instanceof Element&&("setPointerCapture"in y&&y.setPointerCapture(u.pointerId),n={x:u.clientX-t.offsetLeft,y:u.clientY-t.offsetTop})},c=l=>{const u=l;if(!n)return;const p=10,y=Math.max(p,Math.min(window.innerWidth-t.offsetWidth-p,u.clientX-n.x)),g=Math.max(p,u.clientY-n.y);t.style.left=`${y}px`,t.style.top=`${g}px`,this.clampPanelToViewport()},a=()=>{n=null},h=[e,s];for(const l of h)this.addDomListener(l,"pointerdown",o),this.addDomListener(l,"pointermove",c),this.addDomListener(l,"pointerup",a),this.addDomListener(l,"pointercancel",a);this.clampPanelToViewport()}bindRangeControl(t,e,s){this.uiRangeBindings.push(t),t.input.value=String(s);const i=()=>{const n=Number(t.input.value);t.value.textContent=t.format(n),this.setRangeProgress(t.input),e(n)};this.addDomListener(t.input,"input",i),i()}setRangeProgress(t){const e=Number(t.min),s=Number(t.max),i=Number(t.value),n=s-e,r=n<=0?0:(i-e)/n,o=Number.parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--ui-size-scale")),a=16*(Number.isFinite(o)&&o>0?o:1),h=t.clientWidth||1,l=Math.max(h-a,1),u=r*l+a*.5;t.style.setProperty("--range-progress",`${u}px`)}refreshAllRangeProgress(){for(const t of this.uiRangeBindings)this.setRangeProgress(t.input)}clampPanelToViewport(){const{panel:t,handleTop:e,handleBottom:s}=this.uiElements,i=10,n=e.offsetHeight+s.offsetHeight+40,r=Math.max(i,window.innerHeight-n-i),o=Math.min(Math.max(t.offsetTop,i),r);o!==t.offsetTop&&(t.style.top=`${o}px`);const c=window.innerHeight-o-i;t.style.maxHeight=`${Math.max(c,n)}px`;const a=Math.max(i,window.innerWidth-t.offsetWidth-i),h=Math.min(Math.max(t.offsetLeft,i),a);h!==t.offsetLeft&&(t.style.left=`${h}px`)}addDomListener(t,e,s,i){t.addEventListener(e,s,i),this.uiCleanupCallbacks.push(()=>{t.removeEventListener(e,s,i)})}handleResize(){const t=window.innerWidth,e=window.innerHeight;this.camera.aspect=t/Math.max(1,e),this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e),this.clampPanelToViewport(),this.refreshAllRangeProgress()}handlePointerDown(t){if(t.button!==0||this.isUsingTransformControls||this.isTransformDragging)return;this.updatePointerFromEvent(t),this.raycaster.setFromCamera(this.pointer,this.camera);const e=this.raycaster.intersectObjects(Array.from(this.selectable));if(e.length===0){this.selectPlane(null);return}const s=e[0].object.userData.planeId;if(!s){this.selectPlane(null);return}this.selectPlane(s)}handleKeyDown(t){if(t.key==="Escape"){this.selectPlane(null),t.preventDefault();return}t.key==="Delete"&&this.selectedPlaneId&&this.selectedPlaneId!==this.emitterId&&(this.removeObstacle(this.selectedPlaneId),t.preventDefault())}updatePointerFromEvent(t){const e=this.canvas.getBoundingClientRect();this.pointer.x=(t.clientX-e.left)/e.width*2-1,this.pointer.y=-((t.clientY-e.top)/e.height)*2+1}updateSpawnRateFromDensity(){const t=Math.max(.2,this.emitterConfig.particleLifetime*Me);this.emitterConfig.spawnRate=this.particleSystem.maxParticles/t}getEffectiveSpawnRate(){const t=Math.max(Lt,this.uiState.flowLength),e=this.emitterConfig.spawnRate/t;return Math.max(8,Math.min(this.particleSystem.maxParticles*8,e))}syncParticleGradientEndpoints(){this.pathColorScratch.set(this.uiState.pathColor),this.obstructedColorScratch.set(this.uiState.obstructedColor)}computeNormalizedOffPath(t,e){const s=t*3;this.laneOriginScratch.set(this.particleLaneOrigins[s],this.particleLaneOrigins[s+1],this.particleLaneOrigins[s+2]),this.laneDirectionScratch.set(this.particleLaneDirections[s],this.particleLaneDirections[s+1],this.particleLaneDirections[s+2]);const i=this.steeringScratch.copy(e).sub(this.laneOriginScratch).dot(this.laneDirectionScratch);if(i<=0)return 0;this.laneTargetScratch.copy(this.laneDirectionScratch).multiplyScalar(i).add(this.laneOriginScratch);const r=this.steeringScratch.copy(e).sub(this.laneTargetScratch).length()/be;return Math.min(1,Math.max(0,r))}setParticleGradientColor(t,e){const s=Math.min(1,Math.max(0,e));this.blendedColorScratch.copy(this.pathColorScratch).lerp(this.obstructedColorScratch,s),this.particleSystem.setParticleColor(t,this.blendedColorScratch.r,this.blendedColorScratch.g,this.blendedColorScratch.b)}recolorParticlesFromCachedDeviation(t){for(let e=0;e<this.particleSystem.maxParticles;e+=1)this.setParticleGradientColor(e,this.particleOffPathAmounts[e]);t&&this.particleSystem.syncTrailColorHistoryToParticleColors(),this.particleSystem.refreshGpuBuffers()}updateAllWorldMatrices(){for(const t of this.planeEntities.values())t.transformObject.updateMatrixWorld(!0)}refreshEmitterSpawnData(){const t=this.planeEntities.get(this.emitterId);if(!t)return;t.mesh.getWorldQuaternion(this.quaternionScratch),ie(this.quaternionScratch,this.emitterNormal),this.emitterRight.set(1,0,0).applyQuaternion(this.quaternionScratch).normalize(),this.emitterUp.set(0,1,0).applyQuaternion(this.quaternionScratch).normalize();const e=t.mesh.matrixWorld;for(let s=0;s<this.emitterLocalVertices.length;s+=3)this.positionScratch.set(this.emitterLocalVertices[s],this.emitterLocalVertices[s+1],this.emitterLocalVertices[s+2]),this.positionScratch.applyMatrix4(e),this.emitterWorldVertices[s]=this.positionScratch.x,this.emitterWorldVertices[s+1]=this.positionScratch.y,this.emitterWorldVertices[s+2]=this.positionScratch.z}refreshObstacleFieldData(){this.obstacleRuntimes.length=0;for(const[t,e]of this.planeEntities){if(e.kind!=="obstacle")continue;const s=St();me(e.mesh,this.flowConfig.obstacleInfluenceRadius,this.flowConfig.wakeStrength,s),this.obstacleRuntimes.push({id:t,data:s})}}randomUnit(t,e){const s=Math.sin((t+1)*12.9898+e*78.233+this.simTime*.7)*43758.5453;return s-Math.floor(s)}respawnParticleAtEmitter(t){const e=this.emitterWorldVertices.length/3;if(e<=0)return;const s=this.spawnVertexCursor%e;this.spawnVertexCursor+=1;const i=s*3,n=this.emitterWorldVertices[i],r=this.emitterWorldVertices[i+1],o=this.emitterWorldVertices[i+2],c=(this.randomUnit(t,0)-.5)*.3,a=(this.randomUnit(t,1)-.5)*.3;this.positionScratch.set(n,r,o),this.velocityScratch.copy(this.emitterNormal).multiplyScalar(this.emitterConfig.initialSpeed).addScaledVector(this.emitterRight,c).addScaledVector(this.emitterUp,a);const h=Math.pow(Math.max(Lt,this.uiState.flowLength),Ee),l=(.72+this.randomUnit(t,2)*.55)*h;this.particleOffPathAmounts[t]=0,this.particleImpactTurbulence[t]=0,this.setParticleGradientColor(t,0),this.particleSystem.respawnParticle(t,this.positionScratch,this.velocityScratch,this.emitterConfig.particleLifetime*l);const u=t*3;this.particleLaneOrigins[u]=this.positionScratch.x,this.particleLaneOrigins[u+1]=this.positionScratch.y,this.particleLaneOrigins[u+2]=this.positionScratch.z,this.particleLaneDirections[u]=this.emitterNormal.x,this.particleLaneDirections[u+1]=this.emitterNormal.y,this.particleLaneDirections[u+2]=this.emitterNormal.z}initializeRestartParticleDistribution(){const t=this.particleSystem.maxParticles,e=Math.max(.5,this.uiState.flowLength*.9);for(let s=0;s<t;s+=1){this.respawnParticleAtEmitter(s);const i=.02+this.randomUnit(s,5)*.96;this.particleSystem.ages[s]=this.particleSystem.lifetimes[s]*i;const n=s*3;this.positionScratch.set(this.particleLaneOrigins[n],this.particleLaneOrigins[n+1],this.particleLaneOrigins[n+2]),this.laneDirectionScratch.set(this.particleLaneDirections[n],this.particleLaneDirections[n+1],this.particleLaneDirections[n+2]),this.positionScratch.addScaledVector(this.laneDirectionScratch,e*i),this.particleSystem.positions[n]=this.positionScratch.x,this.particleSystem.positions[n+1]=this.positionScratch.y,this.particleSystem.positions[n+2]=this.positionScratch.z}}applyLaneRecovery(t,e,s){if(s)return;const i=t*3;this.laneOriginScratch.set(this.particleLaneOrigins[i],this.particleLaneOrigins[i+1],this.particleLaneOrigins[i+2]),this.laneDirectionScratch.set(this.particleLaneDirections[i],this.particleLaneDirections[i+1],this.particleLaneDirections[i+2]);const n=this.steeringScratch.copy(this.positionScratch).sub(this.laneOriginScratch).dot(this.laneDirectionScratch);if(n<=0||(this.laneTargetScratch.copy(this.laneDirectionScratch).multiplyScalar(n).add(this.laneOriginScratch),this.steeringScratch.copy(this.laneTargetScratch).sub(this.positionScratch),this.steeringScratch.length()<=1e-4))return;const o=Math.max(.1,this.flowConfig.recoveryLength),a=Math.max(.2,Math.abs(this.velocityScratch.dot(this.laneDirectionScratch)))/o*1.2,h=Math.min(.35,a*e);this.velocityScratch.addScaledVector(this.steeringScratch,h)}simulate(t){for(this.simTime+=t,this.updateAllWorldMatrices(),this.refreshEmitterSpawnData(),this.refreshObstacleFieldData(),this.spawnAccumulator+=t*this.getEffectiveSpawnRate();this.spawnAccumulator>=1;)this.respawnParticleAtEmitter(this.spawnParticleCursor),this.spawnParticleCursor=(this.spawnParticleCursor+1)%this.particleSystem.maxParticles,this.spawnAccumulator-=1;const e=Math.exp(-this.flowConfig.drag*t);for(let s=0;s<this.particleSystem.maxParticles;s+=1){if(this.particleSystem.ages[s]+=t,this.particleSystem.ages[s]>=this.particleSystem.lifetimes[s]){this.respawnParticleAtEmitter(s);continue}const i=s*3;this.positionScratch.set(this.particleSystem.positions[i],this.particleSystem.positions[i+1],this.particleSystem.positions[i+2]),this.velocityScratch.set(this.particleSystem.velocities[i],this.particleSystem.velocities[i+1],this.particleSystem.velocities[i+2]),this.baseFlowScratch.copy(this.emitterNormal).multiplyScalar(this.emitterConfig.initialSpeed),this.steeringScratch.copy(this.baseFlowScratch).sub(this.velocityScratch),this.velocityScratch.addScaledVector(this.steeringScratch,Math.min(1,t*1.4));let n=!1,r=!1;for(const a of this.obstacleRuntimes){const h=de(this.positionScratch,this.velocityScratch,a.data,this.emitterNormal,this.simTime,this.flowConfig.turbulenceScale,0);n=n||h,r=r||h}r&&(this.particleImpactTurbulence[s]=1);const o=this.particleImpactTurbulence[s];if(o>1e-4&&this.flowConfig.turbulenceStrength>1e-5){Dt(this.positionScratch,this.simTime,this.flowConfig.turbulenceScale,this.turbulenceScratch),this.turbulenceScratch.addScaledVector(this.emitterNormal,-this.turbulenceScratch.dot(this.emitterNormal));const a=this.turbulenceScratch.lengthSq();a>1e-6&&(this.turbulenceScratch.multiplyScalar(1/Math.sqrt(a)),this.velocityScratch.addScaledVector(this.turbulenceScratch,this.flowConfig.turbulenceStrength*o*t*2.25))}this.applyLaneRecovery(s,t,n),this.velocityScratch.multiplyScalar(e),this.positionScratch.addScaledVector(this.velocityScratch,t),this.particleSystem.positions[i]=this.positionScratch.x,this.particleSystem.positions[i+1]=this.positionScratch.y,this.particleSystem.positions[i+2]=this.positionScratch.z,this.particleSystem.velocities[i]=this.velocityScratch.x,this.particleSystem.velocities[i+1]=this.velocityScratch.y,this.particleSystem.velocities[i+2]=this.velocityScratch.z;const c=this.computeNormalizedOffPath(s,this.positionScratch);if(n)this.particleImpactTurbulence[s]=1;else if(this.particleImpactTurbulence[s]>0){const a=Math.min(1,c*2),h=Math.max(.1,this.flowConfig.recoveryLength),l=Math.min(1,t*(1.2+2.8/h)),u=this.particleImpactTurbulence[s]+(a-this.particleImpactTurbulence[s])*l;this.particleImpactTurbulence[s]=u<.02&&c<.01?0:u}this.particleOffPathAmounts[s]=c,this.setParticleGradientColor(s,c),this.particleSystem.pushTrailSample(s)}this.pendingTrailGradientRecolor&&(this.particleSystem.syncTrailColorHistoryToParticleColors(),this.pendingTrailGradientRecolor=!1),this.particleSystem.refreshGpuBuffers()}animationLoop=()=>{this.animationFrameHandle=requestAnimationFrame(this.animationLoop);const t=performance.now()*.001,e=t-this.lastAnimationTimeSeconds;this.lastAnimationTimeSeconds=t;const s=Math.min(.05,Math.max(1/240,e));if(this.orbitControls.update(),this.playbackState.isPlaying){const i=s*Math.max(.05,this.playbackState.speed)*this.flowConfig.timeScale;this.simulate(i)}else this.pendingTrailGradientRecolor&&(this.pendingTrailGradientRecolor=!1,this.recolorParticlesFromCachedDeviation(!0));this.renderer.render(this.scene,this.camera)};createTransformControl(t,e){const s=new ee(this.camera,this.renderer.domElement);s.setMode(t),s.setSpace("local"),s.setSize(e),s.addEventListener("dragging-changed",()=>{s.dragging?this.setExclusiveTransformControl(s):this.setExclusiveTransformControl(null),this.updateTransformDraggingState()}),s.addEventListener("mouseDown",()=>{this.getTransformControlAxis(s)&&(this.setExclusiveTransformControl(s),this.isUsingTransformControls=!0)}),s.addEventListener("mouseUp",()=>{window.setTimeout(()=>{this.isUsingTransformControls=!1,this.setExclusiveTransformControl(null)},0)}),t==="scale"&&s.addEventListener("objectChange",()=>{this.handleScaleProxyObjectChange()});const i=s.getHelper();return this.stripNonAxisTransformHandles(s,t),t==="translate"&&(this.stripTranslateBackArrows(s),this.resizeTranslateArrowHeads(s,ye)),t==="scale"&&(this.pushBackScaleHandles(s,ge),this.rebuildScaleAxisPickersFromVisibleBoxes(s,xe)),t!=="scale"?this.tightenTransformPickerHitAreas(s,t,t==="rotate"?we:Se):this.tightenTransformPickerHitAreas(s,t,Ce),this.scene.add(i),{control:s,helper:i}}updateTransformDraggingState(){const t=this.transformControls.some(e=>e.dragging);this.isTransformDragging=t,this.orbitControls.enabled=!t}getTransformControlAxis(t){const e=t.axis;return typeof e=="string"?e:null}setExclusiveTransformControl(t){for(const e of this.transformControls)e.enabled=!t||e===t}stripNonAxisTransformHandles(t,e){const s=new Set(e==="scale"?["X","Y","Z","XYZ"]:["X","Y","Z"]),n=t._gizmo;if(!n)return;const r=n.helper?.[e];if(r)for(const c of[...r.children])r.remove(c);const o=[n.gizmo?.[e],n.picker?.[e]];for(const c of o){if(!c)continue;const a=c.children.filter(h=>!s.has(h.name));for(const h of a)c.remove(h)}}stripTranslateBackArrows(t){const e={X:new d(1,0,0),Y:new d(0,1,0),Z:new d(0,0,1)},i=t._gizmo;if(!i)return;const n=[i.gizmo?.translate,i.picker?.translate];for(const r of n)if(r)for(const o of["X","Y","Z"]){const c=r.children.filter(l=>l.name===o);if(c.length<=1)continue;const a=e[o],h=[];for(const l of c){const p=l.geometry;if(!p)continue;p.computeBoundingBox();const y=p.boundingBox;if(!y)continue;y.getCenter(new d).dot(a)<-1e-4&&h.push(l)}for(const l of h)r.remove(l)}}resizeTranslateArrowHeads(t,e){const s={X:new d(1,0,0),Y:new d(0,1,0),Z:new d(0,0,1)},n=t._gizmo?.gizmo?.translate;if(n)for(const r of["X","Y","Z"]){const o=s[r];for(const c of n.children){if(c.name!==r)continue;const h=c.geometry;if(!h)continue;h.computeBoundingBox();const l=h.boundingBox;if(!l)continue;const u=l.getCenter(new d),p=l.getSize(new d),y=Math.max(p.x,p.y,p.z),g=Math.min(p.x,p.y,p.z);if(!(u.dot(o)>.35&&y<=.16&&g>.03))continue;const S=u.clone().multiplyScalar(-1);h.translate(S.x,S.y,S.z),h.scale(e,e,e),h.translate(u.x,u.y,u.z)}}}pushBackScaleHandles(t,e){const s={X:new d(1,0,0),Y:new d(0,1,0),Z:new d(0,0,1)},n=t._gizmo;if(!n)return;const r=n.gizmo?.scale;if(r)for(const o of["X","Y","Z"]){const c=s[o],a=[];for(const h of r.children){if(h.name!==o)continue;const u=h.geometry;if(!u)continue;u.computeBoundingBox();const p=u.boundingBox;if(!p)continue;const y=p.getSize(new d);if(Math.max(y.x,y.y,y.z)>.2)continue;const f=p.getCenter(new d).dot(c);f>1e-4?a.push(h):f<-1e-4&&u.translate(-c.x*e,-c.y*e,-c.z*e)}for(const h of a)r.remove(h)}}rebuildScaleAxisPickersFromVisibleBoxes(t,e){const s=t,i=s._gizmo?.gizmo?.scale,n=s._gizmo?.picker?.scale;if(!(!i||!n)){for(const r of[...n.children])r.userData?.customScalePicker&&(r.geometry?.dispose(),n.remove(r));for(const r of["X","Y","Z"])for(const o of i.children){if(o.name!==r)continue;const a=o.geometry;if(!a)continue;a.computeBoundingBox();const h=a.boundingBox;if(!h)continue;const l=h.getSize(new d),u=Math.max(l.x,l.y,l.z),p=Math.min(l.x,l.y,l.z);if(!(u<=.2&&p>.03))continue;const g=a.clone();g.computeBoundingBox();const E=g.boundingBox;if(!E){g.dispose();continue}const f=E.getCenter(new d);g.translate(-f.x,-f.y,-f.z),g.scale(e,e,e),g.translate(f.x,f.y,f.z),g.computeBoundingBox(),g.computeBoundingSphere();const S=new it(g,this.scalePickerMaterial);S.name=r,S.position.copy(o.position),S.quaternion.copy(o.quaternion),S.scale.copy(o.scale),S.userData.customScalePicker=!0,n.add(S)}}}tightenTransformPickerHitAreas(t,e,s){const n=t._gizmo?.picker?.[e];if(!n)return;const r=new Set;for(const o of n.children){const a=o.geometry;if(!a||r.has(a))continue;a.computeBoundingBox();const h=a.boundingBox;if(!h)continue;const l=h.getCenter(new d);a.translate(-l.x,-l.y,-l.z),a.scale(s,s,s),a.translate(l.x,l.y,l.z),a.computeBoundingBox(),a.computeBoundingSphere(),r.add(a)}}}function Ae(m){return new Te(m)}const kt=document.querySelector("#app-canvas");if(!kt)throw new Error("Canvas element #app-canvas was not found.");const ve=Ae(kt);Object.assign(window,{airflowShaperApp:ve});
